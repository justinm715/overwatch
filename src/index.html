<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overwatch Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
        :root { --col-name: 300px; --col-size: 80px; --col-type: 70px; --col-date: 130px; --col-ago: 100px; --col-path: 350px; }
        html, body { height: 100vh; margin: 0; overflow: hidden; background-color: #f1f5f9; font-family: 'Inter', sans-serif; font-size: 13px; }
        #ghost-line { position: fixed; top: 0; width: 2px; height: 100%; background-color: #3b82f6; display: none; z-index: 100; pointer-events: none; }
        .app-layout { display: flex; height: 100vh; width: 100vw; }
        aside { width: 240px; background: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 1rem; flex-shrink: 0; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; }
        
        #treeHeader, .file-row { display: grid; grid-template-columns: var(--col-name) var(--col-size) var(--col-type) var(--col-date) var(--col-ago) var(--col-path); width: max-content; min-width: 100%; font-size: 11px; }
        #treeHeader { position: sticky; top: 0; z-index: 20; background: #f8fafc; border-bottom: 1px solid #e2e8f0; height: 32px; align-items: center; }
        #treeHeader > div { border-right: 1px solid #e2e8f0; padding: 0 8px; position: relative; color: #64748b; }
        #treeContainer { flex: 1; overflow: auto; contain: content; }
        
        .resizer { position: absolute; right: -4px; top: 0; width: 8px; height: 100%; cursor: col-resize; z-index: 30; }
        .resizer:hover::after { content: ""; position: absolute; left: 50%; width: 2px; height: 100%; background: #3b82f6; }
        
        .folder-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 4px; border-radius: 6px; background: white; border: 1px solid #e2e8f0; cursor: pointer; }
        .folder-item.active { border-color: #3b82f6; background: #eff6ff; }
        .remove-btn { color: #94a3b8; font-size: 16px; transition: color 0.2s; padding: 0 4px; }
        .remove-btn:hover { color: #ef4444; }

        /* File Type Colors */
        .icon-folder { color: #fbbf24; }
        .icon-image { color: #ec4899; }
        .icon-code { color: #3b82f6; }
        .icon-pdf { color: #ef4444; }

        /* Status Indicators */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; flex-shrink: 0; }
        .status-fresh { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; border: 1px solid #16a34a; }
        .status-stale { background-color: #fb923c; opacity: 0.4; }
        .status-neutral { background-color: #cbd5e1; }

        .file-row { height: 28px; align-items: center; border-bottom: 1px solid #f8fafc; color: #334155; }
        .file-row:hover { background-color: #f1f5f9; }
        .path-text { color: #94a3b8; font-size: 10px; text-decoration: underline; text-decoration-color: #e2e8f0; cursor: pointer; }
        .path-text:hover { color: #3b82f6; }
        .copy-btn { opacity: 0; font-size: 9px; padding: 1px 4px; background: #f1f5f9; border-radius: 3px; margin-left: 6px; }
        .file-row:hover .copy-btn { opacity: 1; }

        .folder-content { display: none; border-left: 1px solid #e2e8f0; margin-left: 14px; }
        .folder-content.open { display: block; }
        .chevron { width: 14px; font-size: 9px; color: #94a3b8; }
        .chevron.rotated { transform: rotate(90deg); }
        .mono { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #64748b; }
        .view-toggle button.active { background: #3b82f6; color: white; }
    </style>
</head>
<body>
    <div id="ghost-line"></div>
    <div class="app-layout">
        <aside>
            <h2 class="text-[10px] font-bold uppercase text-slate-400 mb-4 tracking-widest">Sources</h2>
            <div id="dropZone" class="p-3 border-2 border-dashed border-slate-200 rounded-lg text-center cursor-pointer hover:border-blue-400 mb-4 text-[9px] font-bold text-slate-400 uppercase">Drop Source</div>
            <div id="folderList" class="flex-1 overflow-y-auto"></div>
            
            <div class="mt-4 flex flex-col gap-2 pt-4 border-t">
                <button onclick="saveSourceList()" class="w-full py-1.5 text-[9px] font-bold uppercase border border-slate-200 rounded-md hover:bg-slate-50">Save JSON</button>
                <button onclick="openSourceList()" class="w-full py-1.5 text-[9px] font-bold uppercase bg-slate-800 text-white rounded-md hover:bg-slate-700">Open JSON</button>
            </div>
        </aside>

        <main>
            <header class="px-4 py-2 border-b flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <h1 id="currentFolderName" class="text-xs font-bold text-slate-700">No source selected</h1>
                    <span id="viewModeLabel" class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold uppercase">Recent Activity</span>
                </div>
                <div id="toolbar" class="hidden flex items-center gap-3">
                    <div class="view-toggle flex bg-slate-100 p-0.5 rounded-md">
                        <button id="btnTree" onclick="setViewMode('tree')" class="px-2 py-0.5 text-[9px] font-bold uppercase rounded transition-all">Tree</button>
                        <button id="btnRecent" onclick="setViewMode('recent')" class="px-2 py-0.5 text-[9px] font-bold uppercase rounded transition-all">Recent</button>
                    </div>
                    <div id="recentControls" class="flex items-center gap-2"><span class="text-[9px] font-bold text-slate-400 uppercase">Limit:</span><select id="limitSelect" onchange="renderCurrentView()" class="bg-slate-50 text-[9px] font-bold p-1 border rounded outline-none"><option value="25">25</option><option value="50">50</option></select></div>
                    <div id="treeControls" class="hidden"><button onclick="expandAll()" class="text-[9px] font-bold uppercase px-2 py-1 hover:bg-slate-50 border rounded">Expand All</button></div>
                </div>
            </header>

            <div id="treeHeader" class="hidden uppercase font-bold text-slate-400 bg-slate-50">
                <div class="relative">Name <div class="resizer" data-col="name"></div></div>
                <div class="relative text-right">Size <div class="resizer" data-col="size"></div></div>
                <div class="relative text-right">Type <div class="resizer" data-col="type"></div></div>
                <div class="relative text-right">Modified <div class="resizer" data-col="date"></div></div>
                <div class="relative text-right pr-4">Updated</div>
                <div class="relative pl-4">Location <div class="resizer" data-col="path"></div></div>
            </div>

            <div id="treeContainer" class="hidden"><div id="rootNode"></div></div>
            <div id="loading" class="hidden m-auto font-mono text-blue-500 text-[10px] animate-pulse uppercase">Scanning...</div>
            <div id="emptyState" class="m-auto text-slate-400 text-[10px] uppercase font-medium">Ready for Source</div>
        </main>
    </div>

    <script>
        const { invoke } = window.__TAURI__.core;
        const { listen } = window.__TAURI__.event;
        const { save, open: openDialog } = window.__TAURI__.dialog;
        const { writeTextFile, readTextFile } = window.__TAURI__.fs;

        let folders = new Map(); 
        let activePath = null;
        let viewMode = 'recent';

        // --- STARTUP LOGIC ---
        window.addEventListener('DOMContentLoaded', async () => {
            setViewMode(viewMode);
            
            // 1. Initialize Drop Listener first (Always works if dragDropEnabled: true)
            try {
                await listen('tauri://drag-drop', async (event) => {
                    // Tauri v2 payload structure
                    const paths = event.payload.paths; 
                    if (paths && paths.length > 0) {
                        await addFolder(paths[0]); 
                    }
                });
            } catch (e) {
                console.error("Drop listener failed:", e);
            }

            // 2. Auto-load sources second (Might fail if permissions are wrong)
            try {
                await autoLoadSources(); 
            } catch (e) {
                console.warn("Auto-load suppressed due to permissions:", e);
            }
        });

        async function autoLoadSources() {
            try {
                const saved = localStorage.getItem('last_sources');
                if (saved) {
                    const paths = JSON.parse(saved);
                    document.getElementById('loading').classList.remove('hidden');
                    for (const p of paths) await addFolder(p);
                    document.getElementById('loading').classList.add('hidden');
                }
            } catch (e) { console.error("Auto-load failed", e); }
        }

        function saveWorkspace() {
            localStorage.setItem('last_sources', JSON.stringify(Array.from(folders.keys())));
        }

        // --- MANUAL SAVE/OPEN ---
        async function saveSourceList() {
            if (!folders.size) return;
            const path = await save({ filters: [{ name: 'JSON', extensions: ['json'] }] });
            if (path) await writeTextFile(path, JSON.stringify(Array.from(folders.keys())));
        }

        async function openSourceList() {
            const selected = await openDialog({ filters: [{ name: 'JSON', extensions: ['json'] }] });
            if (selected) {
                const paths = JSON.parse(await readTextFile(selected));
                for (const p of paths) await addFolder(p);
            }
        }

        // --- CORE LOGIC ---
        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('btnTree').classList.toggle('active', mode === 'tree');
            document.getElementById('btnRecent').classList.toggle('active', mode === 'recent');
            document.getElementById('recentControls').classList.toggle('hidden', mode !== 'recent');
            document.getElementById('treeControls').classList.toggle('hidden', mode !== 'tree');
            renderCurrentView();
        }

        function getIconClass(node) {
            if (node.is_dir) return 'icon-folder';
            const ext = node.file_type.toLowerCase();
            if (['png', 'jpg', 'svg', 'ai'].includes(ext)) return 'icon-image';
            if (['js', 'rs', 'html', 'json'].includes(ext)) return 'icon-code';
            if (ext === 'pdf') return 'icon-pdf';
            return 'icon-default';
        }

        function getStatusDot(ts) {
            const diff = Date.now() - ts;
            if (diff < 3600000) return `<span class="status-dot status-fresh"></span>`;
            if (diff > 2592000000) return `<span class="status-dot status-stale"></span>`;
            return `<span class="status-dot status-neutral"></span>`;
        }

        function timeAgo(ts) {
            const diff = Date.now() - ts;
            const m = Math.floor(diff / 60000), h = Math.floor(m / 60), d = Math.floor(h / 24);
            if (m < 1) return 'Just now'; if (m < 60) return `${m}m ago`;
            if (h < 24) return `${h}h ago`; return `${d}d ago`;
        }

        // --- RESIZE LOGIC ---
        let activeResizer = null, startX, startWidth;
        document.querySelectorAll('.resizer').forEach(r => {
            r.addEventListener('mousedown', e => {
                activeResizer = r; startX = e.pageX; startWidth = r.parentElement.offsetWidth;
                document.getElementById('ghost-line').style.display = 'block';
                document.body.classList.add('resizing-active');
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
            });
        });
        function onMove(e) { if(activeResizer) document.getElementById('ghost-line').style.left = e.pageX + 'px'; }
        function onUp(e) {
            if(!activeResizer) return;
            document.documentElement.style.setProperty(`--col-${activeResizer.dataset.col}`, Math.max(40, startWidth + (e.pageX - startX)) + 'px');
            document.getElementById('ghost-line').style.display = 'none';
            document.body.classList.remove('resizing-active');
            document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp);
            activeResizer = null;
        }

        listen('tauri://drag-drop', async (event) => {
            console.log("Drop detected:", event); // Debug to see if it's firing
            
            // Tauri v2 structure: event.payload.paths
            const paths = event.payload.paths; 
            
            if (paths && paths.length > 0) {
                // We process the first dropped item
                await addFolder(paths[0]); 
            }
        });

        async function addFolder(path) {
            if(folders.has(path)) return;
            document.getElementById('loading').classList.remove('hidden');
            try {
                const results = await invoke('scan_directory', { path });
                const nodeMap = new Map(Object.entries(results));
                const rootId = Array.from(nodeMap.keys()).sort((a,b) => a.length - b.length)[0];
                
                folders.set(path, { name: path.split(/[\\/]/).pop() || path, nodeMap, rootId });
                
                saveWorkspace();
                updateSidebar();
                
                // Ensure switchFolder is called so the view renders with the correct limit
                switchFolder(path); 
            } catch (err) { 
                console.error(err); 
            }
            document.getElementById('loading').classList.add('hidden');
        }

        function switchFolder(path) {
            activePath = path;
            document.getElementById('toolbar').classList.remove('hidden');
            document.getElementById('treeHeader').classList.remove('hidden');
            document.getElementById('treeContainer').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('currentFolderName').textContent = folders.get(path).name;
            renderCurrentView(); updateSidebar();
        }

        async function renderCurrentView() {
            const container = document.getElementById('rootNode');
            container.innerHTML = '';
            
            // Safety check: only render if a folder path is active
            const data = folders.get(activePath);
            if (!data) return;

            if (viewMode === 'tree') {
                // Standard Hierarchical Tree View
                createNodeEl(data.rootId, container, 0, data.nodeMap);
            } else {
                // Recent Activity View with strictly enforced limit
                try {
                    // 1. Get the current limit from the dropdown
                    const limitSelect = document.getElementById('limitSelect');
                    const currentLimit = parseInt(limitSelect.value) || 25; 

                    // 2. Call the specialized Rust command with the limit
                    const recentItems = await invoke('get_recent_files', { 
                        path: activePath, 
                        limit: currentLimit 
                    });

                    // 3. Clear existing list and render only the returned subset
                    recentItems.forEach(node => {
                        const row = document.createElement('div');
                        row.className = "file-row px-4";
                        const iconClass = getIconClass(node);
                        
                        row.innerHTML = `
                            <div class="truncate pl-2 font-medium">
                                <span class="${iconClass}">${node.is_dir ? 'üìÅ' : 'üìÑ'}</span> ${node.name}
                            </div>
                            <div class="text-right mono">${formatSize(node.size)}</div>
                            <div class="text-right mono">${node.file_type}</div>
                            <div class="text-right mono">${new Date(node.last_modified).toISOString().substring(0,10)}</div>
                            <div class="text-right pr-4 text-[10px] font-bold text-slate-500">
                                ${getStatusDot(node.last_modified)}${timeAgo(node.last_modified)}
                            </div>
                            <div class="pl-4 flex items-center gap-2 overflow-hidden">
                                <span class="truncate path-text" title="Reveal in Explorer" 
                                      onclick="invoke('reveal_in_explorer', { path: '${node.id.replace(/\\/g, '\\\\')}' })">
                                    ${node.id}
                                </span>
                                <button class="copy-btn uppercase font-bold text-slate-500 hover:text-blue-500" 
                                        onclick="navigator.clipboard.writeText('${node.id.replace(/\\/g, '\\\\')}')">
                                    Copy
                                </button>
                            </div>
                        `;
                        container.appendChild(row);
                    });
                } catch (error) {
                    console.error("Failed to render recent view:", error);
                    container.innerHTML = '<p class="p-4 text-red-500">Error loading recent activity.</p>';
                }
            }
        }

        function createNodeEl(id, container, depth, nodeMap) {
            const node = nodeMap.get(id); if (!node) return;
            const row = document.createElement('div'); row.className = "file-row px-4";
            const iconClass = getIconClass(node);
            const name = document.createElement('div');
            name.className = "flex items-center gap-1 truncate";
            name.style.paddingLeft = `${depth * 0.8}rem`;
            const chevron = node.is_dir ? `<span class="chevron">‚ñ∂</span>` : `<span class="w-[14px]"></span>`;
            name.innerHTML = `${chevron} <span class="${iconClass}">${node.is_dir ? 'üìÅ' : 'üìÑ'}</span> <span class="truncate font-medium">${node.name}</span>`;
            row.append(name);
            row.insertAdjacentHTML('beforeend', `<div class="text-right mono">${formatSize(node.size)}</div><div class="text-right mono">${node.file_type}</div><div class="text-right mono">${new Date(node.last_modified).toISOString().substring(0,10)}</div><div class="text-right pr-4 text-slate-500 font-bold">${getStatusDot(node.last_modified)}${timeAgo(node.last_modified)}</div><div class="pl-4 truncate opacity-30 text-[9px]">${node.id}</div>`);
            container.appendChild(row);
            if (node.is_dir) {
                const content = document.createElement('div'); content.className = "folder-content";
                container.appendChild(content);
                row.onclick = () => {
                    const open = content.classList.toggle('open');
                    row.querySelector('.chevron')?.classList.toggle('rotated', open);
                    if (open && !content.innerHTML) node.children.forEach(c => createNodeEl(c, content, depth + 1, nodeMap));
                };
            }
        }

        function updateSidebar() {
            const list = document.getElementById('folderList'); list.innerHTML = '';
            folders.forEach((data, path) => {
                const item = document.createElement('div');
                item.className = `folder-item ${path === activePath ? 'active' : ''}`;
                item.innerHTML = `<span class="truncate text-[11px] font-medium flex-1">üìÅ ${data.name}</span><button class="remove-btn">√ó</button>`;
                item.onclick = () => switchFolder(path);
                item.querySelector('.remove-btn').onclick = (e) => { e.stopPropagation(); removeFolder(path); };
                list.appendChild(item);
            });
        }

        function removeFolder(path) {
            folders.delete(path);
            saveWorkspace();
            if (activePath === path) location.reload();
            updateSidebar();
        }

        function expandAll() { const closed = Array.from(document.querySelectorAll('.file-row')).filter(r => r.nextElementSibling?.classList.contains('folder-content') && !r.nextElementSibling.classList.contains('open')); if(!closed.length) return; closed.forEach(r => r.click()); requestAnimationFrame(expandAll); }
        function formatSize(b) { if(!b) return '0 B'; const k=1024, s=['B','KB','MB','GB'], i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1)) + ' ' + s[i]; }
    </script>
</body>
</html>